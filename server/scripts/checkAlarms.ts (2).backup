import { db } from "../db";
import { alarmConfigs } from "../../shared/schema";
import { eq, lt } from "drizzle-orm";
import dayjs from "dayjs";
import axios from "axios";

async function checkAlarms() {
  const now = new Date();
  console.log("âŒ› Agora:", now.toISOString());

  const expiredAlarms = await db
    .select()
    .from(alarmConfigs)
    .where(lt(alarmConfigs.nextAlarm, now));

  console.log("ðŸ” Alarmes atrasados encontrados:", expiredAlarms.length);

  if (expiredAlarms.length === 0) {
    const all = await db.select().from(alarmConfigs);
    console.log("ðŸ“¦ Todos os alarmes existentes:");
    console.table(
      all.map((a) => ({
        id: a.id,
        userId: a.userId,
        nextAlarm: a.nextAlarm.toISOString(),
      }))
    );
  }

  for (const alarm of expiredAlarms) {
    console.log(`â° Alarme do user ${alarm.userId} estÃ¡ atrasado!`);

    await axios.post("http://localhost:3000/api/send-emergency", {
      userId: alarm.userId,
    });

    const newNextAlarm = dayjs(alarm.nextAlarm)
      .add(alarm.repeatInterval, "hour")
      .toISOString();

    await db
      .update(alarmConfigs)
      .set({ nextAlarm: new Date(newNextAlarm) })
      .where(eq(alarmConfigs.id, alarm.id));

    console.log(`ðŸ• PrÃ³ximo alarme agendado para ${newNextAlarm}`);
  }
}

checkAlarms()
  .then(() => {
    console.log("ðŸ” VerificaÃ§Ã£o concluÃ­da.");
    process.exit(0);
  })
  .catch((err) => {
    console.error("Erro ao verificar alarmes:", err);
    process.exit(1);
  });
