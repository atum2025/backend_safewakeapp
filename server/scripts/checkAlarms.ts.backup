import { db } from "../db"; // ajuste o caminho
import { alarmConfigs } from "../../shared/schema";
import { eq, lt } from "drizzle-orm";
import dayjs from "dayjs";
import axios from "axios";

async function checkAlarms() {
  const now = new Date();

  const expiredAlarms = await db
    .select()
    .from(alarmConfigs)
    .where(lt(alarmConfigs.nextAlarm, now));

  for (const alarm of expiredAlarms) {
    console.log(`⏰ Alarme do user ${alarm.userId} está atrasado!`);

    await axios.post("http://localhost:3000/api/send-emergency", {
      userId: alarm.userId,
    });

    // Aqui, se quiser, atualize o nextAlarm com base no repeat_interval
  }
}

checkAlarms()
  .then(() => {
    console.log("🔁 Verificação concluída.");
    process.exit(0);
  })
  .catch((err) => {
    console.error("Erro ao verificar alarmes:", err);
    process.exit(1);
  });
